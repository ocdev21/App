# Minimal Dockerfile without LLM components
FROM node:18-alpine

# Install Python
RUN apk add --no-cache python3 py3-pip gcc musl-dev libffi-dev

WORKDIR /app

# Copy and install Node dependencies
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# Copy and install minimal Python dependencies
COPY requirements_minimal.txt ./
RUN pip3 install --no-cache-dir -r requirements_minimal.txt

# Copy only essential application files (excluding LLM services)
COPY server/index.ts ./server/
COPY server/routes.ts ./server/
COPY server/storage.ts ./server/
COPY server/clickhouse.ts ./server/
COPY server/db.ts ./server/
COPY server/vite.ts ./server/

# Copy essential services only (no LLM)
COPY server/services/pcap_processor.py ./server/services/
COPY server/services/large_pcap_processor.py ./server/services/
COPY server/services/clickhouse_client.py ./server/services/
COPY server/services/ue_analyzer.py ./server/services/

# Copy frontend
COPY client/ ./client/
COPY shared/ ./shared/
COPY vite.config.ts ./
COPY tsconfig.json ./
COPY tailwind.config.ts ./
COPY postcss.config.js ./
COPY components.json ./

# Expose port
EXPOSE 5000

# Start the application
CMD ["npm", "run", "dev"]